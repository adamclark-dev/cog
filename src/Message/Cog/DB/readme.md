# DB component

## Usage

### Create a connection

	// Create a connection
	$connection = new \Message\Cog\DB\MySQL\Connection(array(
		'host'	=> '127.0.0.1',
		'user'	=> 'root',
		'password' => 'cheese',
		'db'	=> 'test',
	));
	
### Run a query
	
	$query = new Query($connection);
	
	$result = $query->run("SELECT iso_code, name, population, gdp FROM countries");
	
### Query parameters

For security and prevent SQL inject attacks 

	
### Work with the results

Calling `Query::run` returns an instance of the `Result` class. This class is flexible in that it's a normal object and has methods to get at query result data, but it can also be accessed and iterated over like an array:

	foreach($result as $row) {
		var_dump($row->iso_code, $row->name, $row->population, $row->gdp);
	}
	
	var_dump($result[2]);
	var_dump(count($result));

Rows in `Result` objects are always an instance of `stdClass`.

The `Result` object has a few methods to make manipulating result data easier.

- `value` Return the very first column from the very first row in the result.
- `first` Returns the first row in the result. You can also use `$result[0]`.
- `hash` Access the data like an associate key => value array using the first two columns from the result.
- `transpose` Takes the first column from the result and sets it as the key in the output.
- `flatten` Remove all but one column from the result rows
- `bind` todo
- `affected` The number of rows affected (if any) by the query which generated this result.
- `id` The last autoincrement ID generated by this query.
- `columns` Similar to `array_keys()`
- `isFromTransaction` returns a boolean to indicate if the result was created from a normal query or a transaction.

	
### Transactions

	$trans = new Transaction($connection);
	
	$trans
		->add("INSERT INTO products VALUES ('SRF002', 'Winter Scarf', 2.00)")
		->add("SET @PROD_ID = LAST_INSERT_ID()")
		->add("INSERT INTO product_gallery VALUES (@PROD_ID, 'Zoom Image')")
		->setID('GALLERY_ID')
		->add("INSERT INTO gallery_image VALUES (@GALLERY_ID, ?s)", 'scarf.jpg')
		->getID()
	;
	
	$result = $trans->commit();
	
	var_dump($result->value()); // 6
	var_dump($result->isFromTransaction()); // true


## Under the hood

## Faux Connections

For unit testing it's possible to create a connection that always returns a user defined array. 


